<html>
	<head>
		<style>
			body { margin-left: 10%; }
			canvas { width: 100%; height: 100% }
		</style>
		<meta charset="UTF-8">
		<link href="libs/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="libs/bootstrap-slider/bootstrap-slider.min.css" rel="stylesheet">
		<link href="styles/styles.css" rel="stylesheet">
	</head>
	<body>
		<div class="container">
			<h1> Заглавие </h1>
			<div class="row">
				<div id="scene-column" class="col-xs-12 col-sm-12 col-md-8">
					<div id="scene"></div>
					<input type="range" id="lifespan" data-slider-value="0" name="lifespan" data-slider-min="0" data-slider-step="1" data-slider-max="60">
					<p id="stats"></p>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-4">
					<span id="ex18-label-1" class="hidden">Example slider label</span>
					<input id="tempRange" type="range" data-slider-min="-1" data-slider-max="2" data-slider-ticks="[-1, 0, 1, 2]" data-slider-value="0" data-slider-step="1" data-slider-ticks-labels='["0.1", "1", "10", "100"]' data-slider-tooltip="hide"/>
					<br>
			    <span>Слънчеви маси: <span id="tempRangeValue">1</span></span>
					<br>
					<br>
					<button type="submit" onclick="Start(document.getElementById('tempRange'))" class="btn btn-default">Пусни анимацията</button>
					<button type="submit" onclick="Pause()" class="btn btn-default">Пауза</button>
					<hr>
					<div class="col-xs-11 col-sm-11 col-md-11">
						<div class="row">
							Frames: <span id="range"></span>
						</div>
						<div class="row">
							Years: <span id="sundata">0</span>
						</div>
						<div class="row">
							Temperature: <span id="sundata-temperature">5800</span>
						</div>
						<div class="row">
							Radius 1: <span id="sundata-radius1">0.97</span>
						</div>
						<div class="row">
							Radius 2: <span id="sundata-radius2">0.965</span>
						</div>
					</div>
					<div class="col-xs-1 col-sm-1 col-md-1">
						<div class="row"><br></div>
						<div class="row">Billion</div>
						<div class="row">K</div>
						<div class="row">SR</div>
						<div class="row">SR</div>
					</div>
				</div>
			</div>
		</div>

		<script src="libs/jquery-3.2.0.min.js"></script>
		<script src="libs/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
		<script src="libs/bootstrap-slider/bootstrap-slider.min.js"></script>
		<script src="libs/three.min.js"></script>
		<script src="scripts/config.js"></script>
		<script src="scripts/TrackballControls.js"></script>
		<script src="scripts/helper.js"></script>
		<script src="scripts/timeControl.js"></script>
		<script src="scripts/slider.js"></script>
		<script src="data/sundata.js"></script>

    <!-- Custom Shader Code -------------------------->
    <script id="vertexShader" type="x-shader/x-vertex">
    varying vec3 vNormal;
    void main()
    {
        vNormal = normalize( normalMatrix * normal );
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
    </script>

    <!-- fragment shader a.k.a. pixel shader -->
    <script id="fragmentShader" type="x-shader/x-vertex">
    	varying vec3 vNormal;
			uniform vec3 color;

    void main()
    {
      float intensity = pow( 0.7 - dot( vNormal, vec3( 0.0, 0.0, 0.8 ) ), 2.0 );
        gl_FragColor = vec4( color, 1.0 ) * intensity;
    }
    </script>
    <!--------------------------------------------------------------->

		<script>
			var timeSlider = $('#lifespan'),
				timeControl = new TimeControl(timeSlider);

			timeSlider.on('change', function (e) {
				k = parseInt(e.value.newValue, 10);
				updateDataView(k);
				if(animateSun) animateSun(k++);
			});

			var sceneView = $('#scene');
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize(sceneView.width(), window.innerHeight/2 );
			sceneView.append(renderer.domElement)

			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 30, window.innerWidth/window.innerHeight, 0.1, 1000 );
			camera.position.set(0,0,8);
			camera.lookAt(new THREE.Vector3(0,0,0));

			//controling with the mouse
			var controls = new THREE.TrackballControls( camera,  renderer.domElement );
			controls.rotateSpeed = 1.0;
			controls.panSpeed = 0.8;
			controls.noZoom = true;
			controls.noPan = false;
			controls.staticMoving = true;
			controls.dynamicDampingFactor = 0.3;

			//main sphere
			var geometry = new THREE.SphereGeometry( 1, 32, 32 );
			geometry.dynamic = true;
			var texture = new THREE.ImageUtils.loadTexture( 'img8.jpg' );
			var material1 = new THREE.MeshBasicMaterial( { map: texture } );
      sphere = new THREE.Mesh( geometry, material1);
      scene.add( sphere );

			var previous = [];
			for (var i=0; i<geometry.vertices.length; i++)
			{
				previous[i] = 1;
			}

			//sample static sphere
			/*
			var geometry3 = new THREE.SphereGeometry( 1, 8, 8 );
			var material2 = new THREE.MeshPhongMaterial({color:'goldenrod', transparent: true, opacity: 0.2, wireframe: true});
			sphere2 = new THREE.Mesh( geometry3, material2);
			sphere2.position.set(3.5, 0, 0);
      scene.add( sphere2 );
			*/

			//ambient light
			scene.add( new THREE.AmbientLight('white',2) );

      // shader for the glow
      var coronaFlareMaterial = new THREE.ShaderMaterial(
      {
        uniforms: { color: {type: "c", value: new THREE.Color("rgb(0, 0, 0)")}},
        vertexShader:   document.getElementById( 'vertexShader'   ).textContent,
        fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
        blending: THREE.AdditiveBlending,
				depthWrite: 	false,
				polygonOffset: true,
				polygonOffsetFactor: -10,
				polygonOffsetUnits: 100,
        transparent: true
      }   );
      var coronaFlareGeometry = new THREE.SphereGeometry( 1.1, 32, 16 );
			coronaFlareGeometry.dynamic = true;
      var coronaFlares = new THREE.Mesh( coronaFlareGeometry, coronaFlareMaterial );
      scene.add( coronaFlares );

			//---------------------------------------------------
			var coronaGlowMaterial = new THREE.ShaderMaterial(
			{
				uniforms: { color: {type: "c", value: new THREE.Color("rgb(0, 0, 0)")}},
				vertexShader:   document.getElementById( 'vertexShader'   ).textContent,
				fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
				side: THREE.BackSide,
				blending: THREE.AdditiveBlending,
				transparent: true
			}   );

			var coronaGlowGeometry = new THREE.SphereGeometry( 1.2, 32, 16 );
			var coronaGlow = new THREE.Mesh( coronaGlowGeometry, coronaGlowMaterial );
			scene.add( coronaGlow );
			//----------------------------------------------
			var previous2 = [];

			for (var i=0; i<coronaFlareGeometry.vertices.length; i++)
			{
				previous2[i] = 1;
			}
			visualizeColour(6000);
      var animateCoronaFrames = 0;
      function drawFrame()
			{
				requestAnimationFrame( drawFrame );
        if (animateCorona) animateCorona(animateCoronaFrames++);
				controls.update();
				renderer.render( scene, camera );
			}

			var k=0;
			var mass1;
			function animateLife(mass)
			{
				if(k==0)
				{
					mass1 = mass;
					document.getElementById("range").innerHTML=mass;
				}
        if(!isPaused)
        {
            requestAnimationFrame(animateLife);
    				if(animateSun) animateSun(k++);
						timeControl.update(k);

            //document.write(k + '<br>');
            updateDataView(k);
				    controls.update();
				    renderer.render(scene, camera);
        }
			}

	    function Start(mass)
	    {
	        isPaused = false;
	        animateLife(mass);
	    }

	    function Pause()
	    {
	        isPaused = true;
	    }
			drawFrame();

			function updateDataView(k) {
				document.getElementById("range").innerHTML=k;
				var sunDataIndex = Math.floor(k/2);
				document.getElementById("sundata").innerHTML=sunData[sunDataIndex]['time'];
				document.getElementById("sundata-temperature").innerHTML=sunData[sunDataIndex]['temperature'];
				document.getElementById("sundata-radius1").innerHTML=sunData[sunDataIndex]['radius'];
				document.getElementById("sundata-radius2").innerHTML=sunData[sunDataIndex]['radius2'];
			}

		</script>
	</body>
</html>
